# 🚀 開発ロードマップ（ポストMVP / ゼロコスト運用版）

本ドキュメントは **返金待ち期間〜β公開** までを **月額¥0** を前提に進めるためのロードマップです。
既存のロードマップを、無料プロバイダ運用・安全装置・低コストCIに合わせて更新しています。

---

## 🎯 ゴール

- **MVP完成を維持**しつつ、**無料API（OSM/Nominatim/ORS）＋強力なキャッシュ＋UI抑制**で開発を継続。
- 無料のCI/CDと観測性で**不具合を早期検出**、**課金事故を再発させない**。
- Web（Vercel無料）でβ配信 → 反応を見てモバイル展開を判断。

---

## 🧭 指針（Guidelines）

1. **USE_GOOGLE=false** を既定にし、Google API は明示的に切り替えたときだけ使用。
2. **キャッシュ・レート制限・サーキットブレーカー**を全外部APIに装備。
3. **フロントはデバウンス/スロットリング**を徹底（無駄な呼び出しゼロ）。
4. **テストは録画再生（VCR）**で実APIを叩かない。
5. **Secrets/鍵は常にローカルの .env**（`.env.example` のみ共有＆コミット）。

---

## 🗂 マイルストーン（チェックリスト）

### M0: 事故再発防止（今すぐ）

- [x] `.env` をコミット対象から除外（`.env.example` のみ共有）
- [x] **APIキーのローテーション**（Google / OpenAI）
- [x] **Google Geocoding/Places のクォータ**（per-day / per-minute / per-user）設定
- [x] **APIキー制限**（HTTPリファラ / IP / iOS/Android 証明書）

### M1: 無料プロバイダ切替（Backend）

- [ ] **Nominatim ジオコーダ**実装（30日キャッシュ・逆ジオ対応）
- [ ] **ORS ルーティング/Matrix**実装（徒歩・複数候補一括計算）
- [ ] フォールバック（通信不可時にスタブを返す）
- [ ] 自前 **RateLimiter（10〜20 req/min）** と **CircuitBreaker** 実装

### M2: UI 抑制（Frontend）

- [ ] 入力 **デバウンス 700ms**
- [ ] マップ移動 **停止後500msで1回だけ**発火
- [ ] 同一検索の **重複呼び出し禁止**（キーで排他）
- [ ] 結果ソート/ページングは **フロント側で** 処理

### M3: 無料CI/CD・観測性

- [ ] GitHub Actions（lint / test / build）※**実APIコール禁止**
- [ ] 失敗時のログ/アーティファクト保持
- [ ] Webは **Vercel（Hobby）** で自動デプロイ（スケルトンでも可）
- [ ] 予算監視ドキュメント（Budgets & Alerts 設定手順）

### M4: β公開に向けた品質担保

- [ ] E2E（検索→お気に入り→御朱印投稿→ルート表示）
- [ ] 空状態/エラーステート/スケルトンの整備
- [ ] パフォーマンス予算（LCP/CLS）と遅延読み込み

---

## 🔒 セキュリティ / コンプライアンス（最小構成）

- [ ] Dependabot（セキュリティアラート）を有効化
- [ ] 画像アップロードの **拡張子/MIME/サイズ** 検証と **EXIF除去**
- [ ] CORS/CSRF/JWT の基本設定見直し
- [ ] プライバシーポリシー/利用規約のドラフト

---

## 🧭 運用の安全装置（Hardening）

- **バックエンド**:
  - RateLimiter: 10〜20 req/min（環境変数で可変）
  - CircuitBreaker: 5連続失敗で 30s Open
  - リトライ最大1回・指数バックオフ（<=2s）
- **キャッシュ**:
  - ジオコード結果/ルート/Matrixは **30日** キャッシュ
  - キャッシュキーは入出力で決定（例: `dir:foot:lat1,lng1->lat2,lng2`）
- **UX制御**:
  - 入力 <3 文字では検索開始しない
  - 連続中はスピナーではなく **「入力を停止して検索」** 誘導

---

## 📦 リリース（ゼロコスト手順）

1. **Web版** を Vercel Hobby にデプロイ（環境変数は Vercel 側に登録）
2. βテスターを募集し、**利用ログ（匿名・集計）** を解析
3. 反応が良ければ **Expo（無料）** でモバイルに展開（審査費用が掛かる段で意思決定）

---

## 📈 KPI（無料運用で追うべき指標）

- 検索→ルート生成の **成功率（>= 99%）**
- 外部API呼び出し **1ユーザー1日あたり回数**
- キャッシュ **ヒット率（>= 70%）**
- エラー率（429/5xx）・平均レイテンシ

---

## 🧱 リスクと回避策

| リスク | 回避策 |
|---|---|
| 無料APIのレート制限 | RateLimiter＋キャッシュ＋UI抑制（最初に対策済み） |
| OSM精度のばらつき | 手動補正レイヤ/神社マスタで吸収 |
| 返金不成立 | コストゼロ設計で継続、Webのみでβ→判断 |

---

## 📌 ブランチ/PR計画（小さく安全に）

- `chore/secure-env-and-profiles`（完了）
- `feat/geocode-nominatim-cache`（Nominatim＋キャッシュ）
- `feat/routes-ors-osrm`（ORS/OSRM＋Matrix）
- `feat/ui-debounce-throttle`（UI抑制）
- `feat/rate-limit-circuit-breaker`（安全装置）
- `docs/cost-playbook`（運用ガイド）
- `chore/dependabot-updates`（依存の脆弱性解消）

---

## 🧾 付録：Short-term（運用に直結する小タスク）

- お気に入りカードに「＋DBへ取り込む」実装
- マイページの未保存お気に入り → 一括取込
- Places Details のキャッシュ/レート制御（※今後Google使用時のみ）
