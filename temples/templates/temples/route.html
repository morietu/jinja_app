{% extends "layouts/base.html" %}
{% block title %}ルート表示{% endblock %}
{% block content %}
  <h2>ルート表示</h2>

  <div style="display:flex;gap:12px;align-items:center;margin:8px 0;">
    <button id="useMyLocation">現在地を使う</button>
    <span id="status" style="color:#666;"></span>
  </div>

  <div id="map" style="width:100%;height:480px;border:1px solid #ddd"></div>
  <div id="summary" style="margin-top:8px;color:#444;"></div>

  <!-- キープレフィックスのデバッグ（動作確認後に消してOK） -->
  <script>console.log("MAPS_KEY_PREFIX:", "{{ GOOGLE_MAPS_API_KEY|default:''|slice:':6' }}****");</script>

  <script>
    // === ページ状態 ===
    const ORIGIN = {lat: {{ current.lat|default:0 }}, lng: {{ current.lng|default:0 }}};
    const GOAL   = {lat: {{ main.lat|default:0 }},   lng: {{ main.lng|default:0 }}};
    const CANDS  = {{ candidates_json|default:"[]"|safe }}; // [{lat,lng,name},...]

    // === 現在地取得ボタン ===
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("useMyLocation");
      const status = document.getElementById("status");
      btn?.addEventListener("click", () => {
        if (!navigator.geolocation) { status.textContent = "このブラウザは位置情報に非対応です。"; return; }
        status.textContent = "現在地を取得中…";
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const {latitude, longitude} = pos.coords;
            const url = new URL(location.href);
            url.searchParams.set("lat", latitude.toFixed(6));
            url.searchParams.set("lng", longitude.toFixed(6));
            location.href = url.toString();
          },
          () => { status.textContent = "位置情報の取得に失敗しました（権限/設定を確認）"; }
        );
      });
    });

    // === 所要時間で2件選ぶ（Distance Matrix）。失敗時は候補先頭2件にフォールバック ===
    function pickByDriveTime(origin, candidates, cb){
      if (!candidates?.length) return cb([]);
      if (!google.maps.DistanceMatrixService) {  // ライブラリ無しでも落ちない
        return cb(candidates.slice(0,2));
      }
      const svc = new google.maps.DistanceMatrixService();
      svc.getDistanceMatrix({
        origins: [origin],
        destinations: candidates.map(c => ({lat:c.lat, lng:c.lng})),
        travelMode: google.maps.TravelMode.DRIVING,
        drivingOptions: { departureTime: new Date() }
      }, (res, status) => {
        if (status !== "OK") { console.warn("DistanceMatrix:", status, res); return cb(candidates.slice(0,2)); }
        const elems = res.rows?.[0]?.elements || [];
        const ranked = candidates.map((c,i)=>({c,sec: elems[i]?.duration?.value ?? Number.MAX_SAFE_INTEGER}))
                                 .sort((a,b)=>a.sec - b.sec)
                                 .slice(0,2)
                                 .map(x=>x.c);
        cb(ranked);
      });
    }

    // === Google Maps 初期化 ===
    function initMap(){
      const map = new google.maps.Map(document.getElementById("map"), {center: ORIGIN, zoom: 12});
      const ds  = new google.maps.DirectionsService();
      const dr  = new google.maps.DirectionsRenderer({map});

      pickByDriveTime(ORIGIN, CANDS, (stops)=>{
        const waypoints = (stops || []).map(p => ({location: {lat:p.lat, lng:p.lng}, stopover: true}));

        ds.route({
          origin: ORIGIN,
          destination: GOAL,
          waypoints,
          travelMode: google.maps.TravelMode.DRIVING,
          optimizeWaypoints: true
        }, (res, status) => {
          if (status === "OK") {
            dr.setDirections(res);
            const route = res.routes[0];
            let dist = 0, time = 0;
            route.legs.forEach(leg => { dist += (leg.distance?.value || 0); time += (leg.duration?.value || 0); });
            const km  = (dist/1000).toFixed(1);
            const min = Math.round(time/60);
            const names = (stops||[]).map(s=>s.name).join(" → ");
            document.getElementById("summary").textContent =
              `合計距離：約 ${km} km / 予測所要時間：約 ${min} 分` + (names ? `（立寄: ${names}）` : "");
          } else {
            const msg = `DirectionsService Error: ${status} ` + (res?.error_message ? `(${res.error_message})` : "");
            console.error(msg, res);
            document.getElementById("summary").textContent = "ルート計算に失敗: " + msg;
          }
        });

        // 目印マーカー
        new google.maps.Marker({position: ORIGIN, map, title: "出発"});
        (stops||[]).forEach((p,i)=> new google.maps.Marker({position:{lat:p.lat,lng:p.lng}, map, title:`立寄${i+1}: ${p.name||""}`}));
        new google.maps.Marker({position: GOAL, map, title: "目的地"});
      });
    }
  </script>

  <!-- Maps JavaScript（Directions はこのJS内から呼び出し） -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap"></script>
{% endblock %}
