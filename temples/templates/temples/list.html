{% extends "base.html" %}
{% block title %}神社一覧{% endblock %}

{% if not request.user.is_authenticated %}
  {% include "components/auth_callout.html" %}
{% endif %}

{% block content %}
  <h2>神社一覧</h2>

  {% include "components/shrine/search_form.html" %}

  <p style="color:#666;margin:4px 0 12px;">
    検索結果：{{ page_obj.paginator.count|default:shrines|length }} 件
  </p>

  <div class="grid">
    {% for s in shrines %}
      {% include "components/shrine/card.html" with shrine=s %}
    {% empty %}
      <p>神社データがまだありません。</p>
    {% endfor %}
  </div>

  {% if is_paginated %}
    <nav style="margin-top:12px;display:flex;gap:8px;align-items:center;">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">前へ</a>
      {% endif %}
      <span>ページ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">次へ</a>
      {% endif %}
    </nav>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("click", (e) => {
  const a = e.target.closest(".js-route");
  if (!a) return;
  e.preventDefault();
  if (!navigator.geolocation) { location.href = a.href; return; } // 取れないときは遷移
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      location.href = `${a.href}?lat=${lat}&lng=${lng}`;
    },
    () => location.href = a.href
  );
});
</script>
{% endblock %}
