{% extends "base.html" %}
{% block title %}ルート表示{% endblock %}

{% block content %}
  <h2>ルート表示</h2>

  <div style="display:flex;gap:12px;align-items:center;margin:8px 0;">
    <button id="useMyLocation">現在地を使う</button>
    <button class="mode" data-mode="DRIVING">車</button>
    <button class="mode" data-mode="WALKING">徒歩</button>
    <span id="status" style="color:#666;"></span>
  </div>

  {% if not MAPS_API_KEY %}
    <p style="color:#b00;background:#fee;padding:8px;">
      地図APIキーが未設定です。.env に GOOGLE_MAPS_API_KEY を設定してください。
    </p>
  {% endif %}

  <div id="map" style="width:100%;height:480px;border:1px solid #ddd"></div>
  <div id="summary" style="margin-top:8px;color:#444;"></div>

  <script>
  // 所要時間で候補2件を選ぶ（DRIVING/WALKINGのみ）
  function pickByTime(origin, candidates, mode = "DRIVING"){
    return new Promise((resolve) => {
      if (!candidates?.length || !google.maps.DistanceMatrixService) {
        resolve((candidates || []).slice(0,2)); return;
      }
      const svc = new google.maps.DistanceMatrixService();
      const req = {
        origins: [origin],
        destinations: candidates.map(c => ({lat:c.lat, lng:c.lng})),
        travelMode: google.maps.TravelMode[mode] || google.maps.TravelMode.DRIVING,
      };
      if (mode === "DRIVING") req.drivingOptions = { departureTime: new Date() };

      svc.getDistanceMatrix(req, (res, status) => {
        if (status !== "OK") { resolve((candidates || []).slice(0,2)); return; }
        const elems = res.rows?.[0]?.elements || [];
        const ranked = (candidates || [])
          .map((c,i)=>({c,sec: elems[i]?.duration?.value ?? Number.MAX_SAFE_INTEGER}))
          .sort((a,b)=>a.sec - b.sec)
          .slice(0,2)
          .map(x=>x.c);
        resolve(ranked);
      });
    });
  }

  async function initMap(){
    const ORIGIN = {lat: {{ current.lat|default:0 }}, lng: {{ current.lng|default:0 }}};
    const GOAL   = {lat: {{ main.lat|default:0 }},   lng: {{ main.lng|default:0 }}};
    const CANDS  = {{ candidates_json|default:"[]"|safe }};
    const MAP_ID = "{{ MAPS_MAP_ID|default:'DEMO_MAP_ID' }}";

    const map = new google.maps.Map(document.getElementById("map"), {
      center: ORIGIN, zoom: 12, mapId: MAP_ID
    });
    const ds  = new google.maps.DirectionsService();
    const dr  = new google.maps.DirectionsRenderer({ map, suppressMarkers: true });
    const { AdvancedMarkerElement, PinElement } = google.maps.marker;

    let mode = "DRIVING"; // 車 or 徒歩
    let advMarkers = [];
    const clearMarkers = () => { advMarkers.forEach(m => m.map = null); advMarkers = []; };

    async function reroute(){
      const stops = await pickByTime(ORIGIN, CANDS, mode);
      const waypoints = (stops||[]).map(p => ({ location:{lat:p.lat, lng:p.lng}, stopover:true }));

      const req = {
        origin: ORIGIN,
        destination: GOAL,
        travelMode: google.maps.TravelMode[mode],
        optimizeWaypoints: (mode === "DRIVING") // 徒歩は最適化オフ
      };
      if (waypoints.length) req.waypoints = waypoints;
      if (mode === "DRIVING") req.drivingOptions = { departureTime: new Date() };

      ds.route(req, (res, status) => {
        if (status !== "OK") {
          document.getElementById("summary").textContent = "ルート計算に失敗: " + status;
          console.error("DirectionsService Error:", status, res);
          return;
        }
        dr.setDirections(res);

        // サマリ
        const route = res.routes[0];
        let dist=0, time=0;
        route.legs.forEach(leg => { dist += (leg.distance?.value || 0); time += (leg.duration?.value || 0); });
        const km  = (dist/1000).toFixed(1);
        const min = Math.round(time/60);
        const names = (stops||[]).map(s=>s.name).join(" → ");
        document.getElementById("summary").textContent =
          `合計距離：約 ${km} km / 予測所要時間：約 ${min} 分` + (names ? `（立寄: ${names}）` : "");

        // ピン再配置
        clearMarkers();
        advMarkers.push(new AdvancedMarkerElement({ map, position: ORIGIN, title: "出発", content: new PinElement({glyph:"A"}).element }));
        (stops||[]).forEach((p,i)=> advMarkers.push(new AdvancedMarkerElement({
          map, position:{lat:p.lat,lng:p.lng}, title:`立寄${i+1}: ${p.name||""}`,
          content:new PinElement({glyph:String.fromCharCode(66+i)}).element
        })));
        advMarkers.push(new AdvancedMarkerElement({ map, position: GOAL, title: "目的地", content: new PinElement({glyph:"G"}).element }));
      });
    }

    // 交通手段ボタン
    document.querySelectorAll("button.mode").forEach(btn=>{
      btn.addEventListener("click", ()=>{ mode = btn.dataset.mode; reroute(); });
    });

    // 現在地ボタン
    const statusEl = document.getElementById("status");
    document.getElementById("useMyLocation")?.addEventListener("click", () => {
      if (!navigator.geolocation) { statusEl.textContent = "このブラウザは位置情報に非対応です。"; return; }
      statusEl.textContent = "現在地を取得中…";
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const url = new URL(location.href);
          url.searchParams.set("lat", pos.coords.latitude.toFixed(6));
          url.searchParams.set("lng", pos.coords.longitude.toFixed(6));
          location.href = url.toString();
        },
        () => { statusEl.textContent = "位置情報の取得に失敗しました（権限/設定を確認）"; }
      );
    });

    // 初回
    reroute();
  }

  window.initMap = initMap;
</script>









{% endblock %}

{% block scripts %}
  {% if MAPS_API_KEY %}
    <script
      src="https://maps.googleapis.com/maps/api/js?key={{ MAPS_API_KEY }}&callback=initMap&libraries=places,marker&v=weekly&loading=async&map_ids={{ MAPS_MAP_ID }}"
      async defer></script>
  {% endif %}
{% endblock %}

