<form method="get" style="display:flex;flex-wrap:wrap;gap:8px;align-items:end;margin:12px 0;">
  <div>
    <label>キーワード<br>{{ form.q }}</label>
  </div>
  <div>
    <label>都道府県<br>{{ form.pref }}</label>
  </div>
  <div>
    <label>並び替え<br>{{ form.sort }}</label>
  </div>

  <h3 style="margin:0 0 6px;font-size:16px;">
    <a href="{% url 'shrine_detail' shrine.pk %}">{{ shrine.name }}</a>
    {% if shrine.is_favorited %}<span title="お気に入り">★</span>{% endif %}
  </h3>
  
  <div style="align-self:center;">
    <label>{{ form.fav }} お気に入りのみ</label>
    {% if not request.user.is_authenticated %}
      <small style="color:#888;">（ログインで有効）</small>
    {% endif %}
  </div>


    {{ form.lat }} {{ form.lng }}


  <button type="submit">検索</button>
  <button type="button" id="useMyLocation" style="margin-left:8px;">現在地を使う</button>
</form>

<script>
  // 「現在地を使う」→ lat/lng を hidden に入れて sort=nearest でサブミット
  (function(){
    const btn = document.getElementById("useMyLocation");
    if (!btn) return;
    btn.addEventListener("click", () => {
      if (!navigator.geolocation) { alert("このブラウザは位置情報に非対応です"); return; }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = document.querySelector('input[name="lat"]');
          const lng = document.querySelector('input[name="lng"]');
          const sort = document.querySelector('select[name="sort"]');
          if (lat && lng) {
            lat.value = pos.coords.latitude.toFixed(6);
            lng.value = pos.coords.longitude.toFixed(6);
          }
          if (sort) sort.value = "nearest";
          btn.closest("form").submit();
        },
        () => alert("位置情報の取得に失敗しました（権限/設定をご確認ください）")
      );
    });
  })();
</script>
